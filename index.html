<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cacing Arena">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="./icon-192.png" type="image/png">
    <link rel="apple-touch-icon" href="./icon-192.png">
    
    <title>Cacing Arena Pro - Mabar LAN</title>
    <style>
        /* ... KODE CSS YANG SUDAH ADA ... */
        
        /* TAMBAHKAN INI DI AKHIR CSS */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        #pwa-install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(168,85,247,0.4);
            display: none;
            animation: fadeIn 0.3s, pulse 2s infinite;
        }
        
        #pwa-install-btn:hover {
            animation: none;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- ... SEMUA HTML YANG SUDAH ADA ... -->
    
    <!-- TAMBAHKAN INI SEBELUM </body> -->
    <button id="pwa-install-btn">ðŸ“² INSTALL GAME</button>

    <!-- PEERJS SCRIPT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>

    <script>
        // ==================== KODE GAME YANG SUDAH ADA ... ====================
        // ... SEMUA KODE GAME ANDA YANG SUDAH ADA ...
        // ... CONFIG, CLASS, Game, Room, Chat, dll ...
        
        // ==================== SIMPLE PWA MANAGER ====================
        const PWAManager = {
            init() {
                console.log('PWA Manager initializing...');
                
                // Cek apakah sudah diinstall
                this.checkIfInstalled();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Register Service Worker
                this.registerServiceWorker();
                
                // Setup install button
                this.setupInstallButton();
            },
            
            checkIfInstalled() {
                const isInstalled = 
                    window.matchMedia('(display-mode: standalone)').matches ||
                    window.navigator.standalone === true;
                
                console.log('PWA Installed:', isInstalled);
                
                if (isInstalled) {
                    console.log('âœ… Running as installed PWA');
                    this.onPWAInstalled();
                }
            },
            
            setupEventListeners() {
                let deferredPrompt;
                
                // Before install prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    console.log('ðŸš€ beforeinstallprompt event fired');
                    e.preventDefault();
                    deferredPrompt = e;
                    
                    // Tampilkan tombol install setelah 3 detik
                    setTimeout(() => {
                        if (deferredPrompt) {
                            this.showInstallButton();
                        }
                    }, 3000);
                    
                    // Simpan ke window untuk akses global
                    window.deferredPrompt = deferredPrompt;
                });
                
                // App installed
                window.addEventListener('appinstalled', (e) => {
                    console.log('âœ… App installed successfully');
                    this.hideInstallButton();
                    if (window.showMessage) {
                        window.showMessage('ðŸŽ‰ Game berhasil diinstall!', 3000);
                    }
                });
            },
            
            registerServiceWorker() {
                if (!('serviceWorker' in navigator)) {
                    console.log('âš ï¸ Service Worker not supported');
                    return;
                }
                
                window.addEventListener('load', () => {
                    // Coba register service worker sederhana
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('âœ… Service Worker registered:', registration.scope);
                        })
                        .catch(error => {
                            console.log('âŒ Service Worker failed:', error);
                            // Buat service worker inline jika file tidak ada
                            this.createInlineServiceWorker();
                        });
                });
            },
            
            createInlineServiceWorker() {
                // Buat service worker sederhana secara inline
                const swContent = `
                    self.addEventListener('install', (event) => {
                        console.log('Service Worker: Installing...');
                        event.waitUntil(
                            caches.open('cacing-arena-v1').then((cache) => {
                                console.log('Service Worker: Caching App Shell');
                                return cache.addAll([
                                    './',
                                    './index.html',
                                    './manifest.json'
                                ]);
                            })
                        );
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((response) => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                
                const blob = new Blob([swContent], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('âœ… Inline Service Worker registered');
                        URL.revokeObjectURL(swUrl);
                    })
                    .catch(error => {
                        console.log('âŒ Inline Service Worker failed:', error);
                    });
            },
            
            setupInstallButton() {
                const installBtn = document.getElementById('pwa-install-btn');
                if (!installBtn) return;
                
                installBtn.addEventListener('click', async () => {
                    if (!window.deferredPrompt) {
                        this.showInstallGuide();
                        return;
                    }
                    
                    try {
                        console.log('Showing install prompt...');
                        window.deferredPrompt.prompt();
                        
                        const { outcome } = await window.deferredPrompt.userChoice;
                        console.log('User choice:', outcome);
                        
                        window.deferredPrompt = null;
                        this.hideInstallButton();
                    } catch (error) {
                        console.log('Install error:', error);
                        this.showInstallGuide();
                    }
                });
            },
            
            showInstallButton() {
                const installBtn = document.getElementById('pwa-install-btn');
                if (installBtn) {
                    installBtn.style.display = 'block';
                    
                    // Auto hide setelah 15 detik
                    setTimeout(() => {
                        this.hideInstallButton();
                    }, 15000);
                }
            },
            
            hideInstallButton() {
                const installBtn = document.getElementById('pwa-install-btn');
                if (installBtn) {
                    installBtn.style.display = 'none';
                }
            },
            
            showInstallGuide() {
                // Gunakan fungsi showMessage yang sudah ada
                if (window.showMessage) {
                    window.showMessage('ðŸ“² Untuk install: Menu browser â†’ "Install App"', 5000);
                } else {
                    // Fallback alert
                    alert('ðŸ“² Untuk install game:\n\nChrome/Edge: Klik menu (â‹®) â†’ "Install Cacing Arena"\nSafari: Klik share (â–¡â†‘) â†’ "Add to Home Screen"');
                }
            },
            
            onPWAInstalled() {
                console.log('PWA features activated');
                this.hideInstallButton();
                
                // Force landscape jika mungkin
                if (screen.orientation && screen.orientation.lock) {
                    try {
                        screen.orientation.lock('landscape');
                    } catch (e) {
                        console.log('Orientation lock not supported');
                    }
                }
            }
        };
        
        // ==================== MODIFIKASI INIT FUNCTION ====================
        // Simpan function init yang sudah ada
        const originalInit = window.init || function() {};
        
        // Override function init
        function init() {
            console.log("Initializing game...");
            
            // Setup canvas
            const canvas = document.getElementById('game');
            if (canvas) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            // Setup touch controls
            if (typeof setupTouchControls === 'function') {
                setupTouchControls();
            }
            
            // Create audio system
            if (typeof SpeechAudio === 'function') {
                window.GameAudio = new SpeechAudio();
            }
            
            // Create audio button
            if (typeof createAudioButton === 'function') {
                createAudioButton();
            }
            
            // Setup keyboard controls
            if (typeof setupKeyboardControls === 'function') {
                setupKeyboardControls();
            }
            
            // Initialize PWA Manager
            PWAManager.init();
            
            // Hide loading setelah 1.5s
            setTimeout(() => {
                const loading = document.getElementById('loading');
                const uiLayer = document.getElementById('ui-layer');
                
                if (loading) loading.style.display = 'none';
                if (uiLayer) uiLayer.style.display = 'flex';
                
                console.log("Game ready!");
                
                // Mainkan suara welcome
                if (window.GameAudio && typeof window.GameAudio.play === 'function') {
                    setTimeout(() => window.GameAudio.play('welcome'), 500);
                }
            }, 1500);
            
            // Force landscape on mobile
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(() => {
                    console.log("Orientation lock not supported");
                });
            }
            
            // Panggil original init jika ada
            if (typeof originalInit === 'function') {
                originalInit();
            }
        }
        
        // ==================== RESIZE HANDLER ====================
        function resizeCanvas() {
            const canvas = document.getElementById('game');
            if (canvas) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                console.log(`Canvas resized: ${canvas.width}x${canvas.height}`);
            }
        }
        
        // ==================== SETUP TOUCH CONTROLS ====================
        function setupTouchControls() {
            const canvas = document.getElementById('game');
            if (!canvas) return;
            
            let isTouching = false;
            
            canvas.addEventListener('touchstart', (e) => {
                if (!GameState.player || !GameState.active || GameState.paused) return;
                e.preventDefault();
                isTouching = true;
                handleTouch(e.touches[0]);
            });
            
            canvas.addEventListener('touchmove', (e) => {
                if (!GameState.player || !GameState.active || !isTouching || GameState.paused) return;
                e.preventDefault();
                handleTouch(e.touches[0]);
            });
            
            canvas.addEventListener('touchend', () => {
                isTouching = false;
            });
            
            function handleTouch(touch) {
                const rect = canvas.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                const touchY = touch.clientY - rect.top;
                
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                const dx = touchX - centerX;
                const dy = touchY - centerY;
                const angle = Math.atan2(dy, dx);
                
                if (GameState.player) {
                    GameState.player.targetAngle = angle;
                }
            }
        }
        
        // ==================== EVENT LISTENERS ====================
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('load', init);
        
        // ==================== EXPORT FUNCTIONS ====================
        window.Game = Game;
        window.Room = Room;
        window.Chat = Chat;
        window.shoot = shoot;
        window.activateSpeed = activateSpeed;
        window.activateMagnet = activateMagnet;
        window.pauseGame = pauseGame;
        window.PWAManager = PWAManager;
        window.init = init;
        window.resizeCanvas = resizeCanvas;

        console.log("ðŸ‘¥ Cacing Mabar Arena Loaded!");
    </script>
</body>
</html>